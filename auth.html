<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication | WASI OTP</title>
    
    <!-- Scripts & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Public Sans', sans-serif; background-color: #fcfcfd; overflow-x: hidden; }
        
        /* AUTH CARD MATCH */
        .auth-card { 
            background: #ffffff; border: 1px solid #f1f5f9; box-shadow: 0 4px 25px rgba(0,0,0,0.03);
            width: 100%; max-width: 385px; border-radius: 8px; padding: 35px 30px; 
        }

        /* INPUT BOXES */
        label { color: #212529; font-weight: 500; font-size: 14px; margin-bottom: 8px; display: block; }
        input {
            width: 100%; height: 45px; padding: 0 15px; background-color: #fff;
            border: 1px solid #ced4da; border-radius: 4px; outline: none;
            color: #495057; font-size: 14px; transition: 0.2s;
        }
        input:focus { border-color: #050a30; }
        input::placeholder { color: #adb5bd; font-weight: 400; }

        /* TOP CENTER NOTIFICATION (TOAST) */
        #notification {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            z-index: 1000; min-width: 300px; padding: 14px 24px; border-radius: 12px;
            color: white; font-weight: 700; font-size: 13px; text-transform: uppercase;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        #notification.show { top: 25px; }
        .bg-success { background-color: #050a30; border-bottom: 4px solid #22c55e; }
        .bg-error { background-color: #050a30; border-bottom: 4px solid #ef4444; }

        /* BUTTON & SPINNER */
        .navy-btn { 
            background-color: #050a30; color: white; font-weight: 600; text-transform: uppercase;
            letter-spacing: 1px; height: 48px; border-radius: 4px; width: 100%;
            font-size: 14px; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .navy-btn:hover { background-color: #000; }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none; }
        .footer-link { color: #212529; font-weight: 700; cursor: pointer; border-bottom: 1px solid transparent; transition: 0.2s; }
        .footer-link:hover { border-color: #212529; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- TOP CENTER NOTIFICATION BAR -->
    <div id="notification">
        <i id="notif-icon" class="fas"></i>
        <span id="notif-msg">Message</span>
    </div>

    <div class="auth-card">
        
        <!-- 1. SIGN IN VIEW -->
        <div id="signin-view">
            <h1 class="text-[22px] font-bold text-[#212529] mb-1">Sign In</h1>
            <p class="text-[#6c757d] text-[14px] mb-8">Enter your email and password to login</p>

            <form id="login-form" class="space-y-5">
                <div><label>Email Address</label><input type="email" id="l-email" placeholder="Enter Email" required></div>
                <div><label>Password</label><input type="password" id="l-password" placeholder="Enter Password" required></div>
                <button type="submit" id="login-btn" class="navy-btn mt-2">
                    <span class="spinner" id="l-spinner"></span>
                    <span id="l-text">SIGN IN</span>
                </button>
            </form>

            <div class="mt-10 text-center space-y-2">
                <p class="text-[13px] text-[#6c757d]">Forgot Password ? <span class="footer-link">Reset Password</span></p>
                <p class="text-[13px] text-[#6c757d]">Don't have an account ? <span onclick="toggleView('signup')" class="footer-link">Sign Up</span></p>
            </div>
        </div>

        <!-- 2. SIGN UP VIEW -->
        <div id="signup-view" class="hidden">
            <h1 class="text-[22px] font-bold text-[#212529] mb-1">Sign Up</h1>
            <p class="text-[#6c757d] text-[14px] mb-8">Create your new account</p>

            <form id="signup-form" class="space-y-4">
                <div><label>Full Name</label><input type="text" id="s-name" placeholder="Enter Name" required></div>
                <div><label>Email Address</label><input type="email" id="s-email" placeholder="Enter Email" required></div>
                <div><label>Password</label><input type="password" id="s-password" placeholder="Min 6 Characters" required></div>
                <div><label>Confirm Password</label><input type="password" id="s-confirm" placeholder="Repeat Password" required></div>
                
                <div class="flex items-start gap-3 py-1">
                    <input type="checkbox" id="terms" required class="mt-1 accent-[#050a30]" style="width:16px; height:16px;">
                    <label for="terms" class="text-[12px] text-[#6c757d] font-normal leading-tight m-0">
                        I agree with the <span class="text-red-600 font-bold">Terms Policy</span>
                    </label>
                </div>

                <button type="submit" id="signup-btn" class="navy-btn mt-2">
                    <span class="spinner" id="s-spinner"></span>
                    <span id="s-text">SIGN UP</span>
                </button>
            </form>

            <div class="text-center mt-6">
                <p class="text-[13px] text-[#6c757d]">Already have an account ? <span onclick="toggleView('signin')" class="footer-link">Sign In</span></p>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE INITIALIZATION
        const _0xWasi = ["QUl6YVN5Q1Z0MFpGb1UyNkRhLWpqQ1FFRXVFRjNBekRBUzMyLVB3", "b3RwYnl3YXNpLmZpcmViYXNlYXBwLmNvbQ==", "aHR0cHM6Ly9vdHBieXdhc2ktZGVmYXVsdC1ydGRiLmZpcmViYXNlbW8uY29t", "b3RwYnl3YXNp", "b3RwYnl3YXNpLmZpcmViYXNlc3RvcmFnZS5hcHA=", "MTE2OTI1MjI5Ng==", "MToxMTY5MjUyMjk2OndlYjo3MzJjMWYwOGY2YjZlZDcwMzNlYWZk"];
        const firebaseConfig = { apiKey: atob(_0xWasi[0]), authDomain: atob(_0xWasi[1]), databaseURL: atob(_0xWasi[2]), projectId: atob(_0xWasi[3]), storageBucket: atob(_0xWasi[4]), messagingSenderId: atob(_0xWasi[5]), appId: atob(_0xWasi[6]) };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();

        // 1. STYLISH NOTIFICATION LOGIC
        function notify(msg, type) {
            const el = document.getElementById('notification');
            const icon = document.getElementById('notif-icon');
            const txt = document.getElementById('notif-msg');

            txt.innerText = msg;
            el.className = (type === 'success') ? 'bg-success show' : 'bg-error show';
            icon.className = (type === 'success') ? 'fas fa-check-circle' : 'fas fa-circle-exclamation';

            setTimeout(() => { el.classList.remove('show'); }, 3500);
        }

        // 2. VIEW TOGGLE
        function toggleView(v) {
            document.getElementById('signin-view').classList.toggle('hidden', v === 'signup');
            document.getElementById('signup-view').classList.toggle('hidden', v === 'signin');
        }

        // 3. LOGIN LOGIC
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            const spin = document.getElementById('l-spinner');
            const email = document.getElementById('l-email').value;
            const pass = document.getElementById('l-password').value;

            btn.disabled = true; spin.style.display = "block";

            auth.signInWithEmailAndPassword(email, pass)
                .then(() => {
                    notify("Login Successful! Redirecting...", "success");
                    setTimeout(() => { window.location.replace("user"); }, 1500);
                })
                .catch(err => {
                    // Smart Error Mapping
                    let errorMsg = "Invalid email or password!";
                    if(err.code === "auth/invalid-email") errorMsg = "Please enter a valid email!";
                    if(err.code === "auth/too-many-requests") errorMsg = "Too many attempts! Try later.";
                    
                    notify(errorMsg, "error");
                    btn.disabled = false; spin.style.display = "none";
                });
        });

        // 4. SIGNUP LOGIC (Strict Creation)
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('s-name').value.trim();
            const email = document.getElementById('s-email').value.trim();
            const pass = document.getElementById('s-password').value;
            const confirm = document.getElementById('s-confirm').value;

            // Password Checks
            if(pass.length < 6) return notify("Password must be 6+ characters!", "error");
            if(pass !== confirm) return notify("Passwords do not match!", "error");

            const btn = document.getElementById('signup-btn');
            const spin = document.getElementById('s-spinner');
            btn.disabled = true; spin.style.display = "block";

            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                
                // Force Create Firestore Document
                await db.collection("users").doc(cred.user.uid).set({
                    username: name, email: email, balance: 0, totalRecharged: 0,
                    totalNumbersBought: 0, role: "user", createdAt: new Date()
                }, { merge: true });

                notify("Account Created Successfully!", "success");
                setTimeout(() => { window.location.replace("user"); }, 1500);

            } catch (err) {
                let errorMsg = "Registration Failed!";
                if(err.code === "auth/email-already-in-use") errorMsg = "Email already registered!";
                
                notify(errorMsg, "error");
                btn.disabled = false; spin.style.display = "none";
            }
        });

        // Auto-redirect if session exists
        auth.onAuthStateChanged((user) => {
            if (user && !document.getElementById('notification').classList.contains('show')) {
                window.location.replace("user");
            }
        });
    </script>
</body>
</html>