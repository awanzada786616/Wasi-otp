<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Buy Number</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial,sans-serif;background:#f5f7fb;padding:20px;}
.card{max-width:420px;margin:auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.08);}
h2{margin-bottom:15px;}
select,button{width:100%;padding:12px;margin-bottom:12px;border-radius:8px;border:1px solid #ccc;font-size:15px;}
button{background:#0b1b4b;color:#fff;border:none;font-weight:bold;cursor:pointer;}
button:disabled{background:#999;}
.status{margin-top:15px;background:#f1f5f9;padding:10px;border-radius:8px;font-size:14px;white-space:pre-wrap;}
.empty{text-align:center;margin-top:30px;color:#777;}
</style>
</head>
<body>

<div class="card">
<h2>Buy Number</h2>

<select id="country"><option value="">Select Country</option></select>
<select id="service" disabled><option value="">Select Service</option></select>
<button onclick="buyNumber()">Buy Number</button>

<div id="result" class="status"></div>
</div>

<div class="empty" id="emptyText">No Any Active Numbers</div>

<script>
const PROVIDER = 1;

// Load countries properly
fetch(`/api/countries?type=${PROVIDER}`)
  .then(res => res.json())
  .then(data => {
    const select = document.getElementById("country");
    select.innerHTML = `<option value="">Select Country</option>`;

    // Nested JSON fix: use string key
    const countries = data[PROVIDER.toString()];  

    if (!countries || countries.length === 0) {
      console.error("No countries found for provider:", PROVIDER);
      return;
    }

    countries.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;       // Country ID
      opt.textContent = c.name; // Country Name
      select.appendChild(opt);
    });
  })
  .catch(err => console.error("Countries load error:", err));

// Load services on country change
document.getElementById("country").addEventListener("change", () => {
  const country = document.getElementById("country").value;
  const serviceSelect = document.getElementById("service");
  serviceSelect.innerHTML = `<option value="">Select Service</option>`;
  serviceSelect.disabled = true;

  if (!country) return;

  fetch(`/api/services?country=${country}&type=${PROVIDER}`)
    .then(res => res.json())
    .then(data => {
      data.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name;
        serviceSelect.appendChild(opt);
      });
      serviceSelect.disabled = false;
    })
    .catch(err => console.error("Services load error:", err));
});

// Buy number
function buyNumber() {
  const country = document.getElementById("country").value;
  const service = document.getElementById("service").value;
  const result = document.getElementById("result");

  if (!country || !service) {
    alert("Select country & service");
    return;
  }

  result.textContent = "Requesting number...";
  fetch(`/api/getNumber?country=${country}&service=${service}&type=${PROVIDER}`)
    .then(res => res.text())
    .then(txt => {
      result.textContent = txt;
      document.getElementById("emptyText").style.display = "none";
    })
    .catch(err => result.textContent = "Error: " + err);
}
</script>

</body>
</html>
