<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Buy Number</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial,sans-serif;background:#f5f7fb;padding:20px;}
.card{max-width:420px;margin:auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.08);}
h2{margin-bottom:15px;}
select,button{width:100%;padding:12px;margin-bottom:12px;border-radius:8px;border:1px solid #ccc;font-size:15px;}
button{background:#0b1b4b;color:#fff;border:none;font-weight:bold;cursor:pointer;}
button:disabled{background:#999;}
.status{margin-top:15px;background:#f1f5f9;padding:10px;border-radius:8px;font-size:14px;white-space:pre-wrap;}
.empty{text-align:center;margin-top:30px;color:#777;}
</style>
</head>
<body>

<div class="card">
<h2>Buy Number</h2>

<select id="country"><option value="">Select Country</option></select>
<select id="service" disabled><option value="">Select Service</option></select>
<button onclick="buyNumber()">Buy Number</button>

<div id="result" class="status"></div>
</div>

<div class="empty" id="emptyText">No Any Active Numbers</div>

<script>
const PROVIDER = 1;

// -----------------------------
// Load countries (100% fixed)
// -----------------------------
async function loadCountries() {
  try {
    const res = await fetch(`/api/countries?type=${PROVIDER}`);
    const countries = await res.json(); // Must be JSON array from backend
    const select = document.getElementById("country");
    select.innerHTML = `<option value="">Select Country</option>`;

    if (!countries || countries.length === 0) {
      console.error("No countries returned from API");
      return;
    }

    countries.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name; // Only show name
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Countries load error:", err);
  }
}

// -----------------------------
// Load services on country select
// -----------------------------
async function loadServices(countryId) {
  const serviceSelect = document.getElementById("service");
  serviceSelect.innerHTML = `<option value="">Select Service</option>`;
  serviceSelect.disabled = true;

  if (!countryId) return;

  try {
    const res = await fetch(`/api/services?country=${countryId}&type=${PROVIDER}`);
    const services = await res.json();
    services.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.name;
      serviceSelect.appendChild(opt);
    });
    serviceSelect.disabled = false;
  } catch (err) {
    console.error("Services load error:", err);
  }
}

// -----------------------------
// Buy number
// -----------------------------
async function buyNumber() {
  const country = document.getElementById("country").value;
  const service = document.getElementById("service").value;
  const result = document.getElementById("result");

  if (!country || !service) {
    alert("Select country & service");
    return;
  }

  result.textContent = "Requesting number...";

  try {
    const res = await fetch(`/api/getNumber?country=${country}&service=${service}&type=${PROVIDER}`);
    const text = await res.text();
    result.textContent = text;
    document.getElementById("emptyText").style.display = "none";
  } catch (err) {
    result.textContent = "Error: " + err;
  }
}

// -----------------------------
// Event listeners
// -----------------------------
document.getElementById("country").addEventListener("change", (e) => {
  loadServices(e.target.value);
});

// Initial load
loadCountries();
</script>

</body>
</html>
