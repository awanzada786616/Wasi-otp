<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Fund | WASI OTP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Public Sans', sans-serif; background-color: #f8f9fa; }
        .main-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; width: 100%; max-width: 500px; padding: 30px; }
        
        /* Top Right Toast */
        #notification-box {
            position: fixed; top: 20px; right: -400px; z-index: 1000;
            width: 280px; padding: 15px; border-radius: 10px; color: white;
            font-weight: 600; font-size: 13px; transition: right 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        #notification-box.show { right: 20px; }
        .bg-err { background-color: #e53e3e; }
        .bg-suc { background-color: #38a169; }

        input { width: 100%; height: 45px; padding: 0 15px; border: 1px solid #ced4da; border-radius: 4px; outline: none; font-size: 14px; }
        input:focus { border-color: #050a30; }
        
        .add-fund-btn { background-color: #050a30; color: white; padding: 12px; border-radius: 6px; width: 100%; font-weight: 700; font-size: 14px; transition: 0.3s; text-transform: uppercase; }
        
        /* Bottom Marquee Strip */
        .marquee-strip { position: fixed; bottom: 0; left: 0; width: 100%; background: #0000ff; color: white; height: 30px; display: flex; align-items: center; z-index: 50; }
    </style>
</head>
<body class="flex flex-col items-center pt-10 px-4 pb-20">

    <!-- Top Right Corner Notification -->
    <div id="notification-box">
        <i id="notif-icon" class="fas"></i>
        <span id="notif-text"></span>
    </div>

    <!-- Top Info Bar -->
    <div class="w-full max-w-[500px] bg-white border border-slate-200 rounded-lg p-3 flex justify-between items-center mb-6 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="bg-slate-900 text-white w-7 h-7 rounded-full flex items-center justify-center text-xs"><i class="fas fa-bell"></i></div>
            <p class="text-[11px] font-medium text-slate-600">If You Are Facing Any Problem Please Contact Us</p>
        </div>
        <button class="bg-[#050a30] text-white text-[10px] font-bold px-3 py-1.5 rounded uppercase">Contact Us</button>
    </div>

    <!-- Main Deposit Container -->
    <div class="main-card shadow-sm">
        <div class="flex items-center gap-3 mb-8">
            <i class="fas fa-mobile-screen text-slate-400"></i>
            <div>
                <h2 class="text-[15px] font-bold text-slate-800">Easypaisa to Easypaisa Auto</h2>
                <p class="text-[11px] text-gray-400 font-medium">You Can Pay Using Easypaisa to Easypaisa</p>
            </div>
        </div>

        <!-- Logo -->
        <div class="text-center mb-10">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQY5o995NZOd7RBuf_3LEVFjN4-pG8dsx2DVg&s" alt="Easypaisa" class="mx-auto w-48">
        </div>

        <!-- Instructions -->
        <div class="text-center space-y-2 mb-10">
            <h3 class="text-3xl font-black text-slate-800 mb-4">Instructions</h3>
            <p class="text-[14px] font-medium text-slate-600 leading-tight">Minimum payment: 50 Rs</p>
            <p class="text-[14px] font-medium text-slate-600 leading-tight">Maximum payment: As much as you want</p>
            <p class="text-[14px] font-medium text-slate-600 leading-tight">Only Easypaisa To Easypaisa Auto</p>
            <p class="text-[12px] text-slate-500 italic px-4 leading-relaxed">
                â€¢ If You Will Send from other wallets you will waste your payment by yourself
            </p>
            <div class="pt-4 space-y-1">
                <p class="text-[15px] font-bold text-slate-800 uppercase">Account Number:- 03175768178</p>
                <p class="text-[15px] font-bold text-slate-800 uppercase">Account Title :- Munir Akhtar</p>
            </div>
        </div>

        <!-- Form Inputs -->
        <div class="space-y-6">
            <div>
                <label class="text-[14px] font-bold text-slate-700 block mb-2">Enter Amount (PKR)</label>
                <input type="number" id="amt-input" placeholder="">
            </div>
            <div>
                <label class="text-[14px] font-bold text-slate-700 block mb-2">Transaction ID</label>
                <input type="text" id="trx-input" placeholder="e.g., 12345678901">
            </div>
            <button onclick="startAutoVerify()" id="add-fund-btn" class="add-fund-btn shadow-lg">
                Add Fund
            </button>
        </div>
    </div>

    <!-- Bottom Marquee Strip -->
    <div class="marquee-strip">
        <marquee behavior="scroll" direction="left" scrollamount="6" class="text-[11px] font-black uppercase tracking-widest px-4">
            MINIMUM PAYMENT IS 50 PLEASE DON'T SEND LESS MINIMUM WE ARE NOT RESPONSIBLE FOR LOSS
        </marquee>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = { apiKey: "AIzaSyCVt0ZFoU26Da-jjCQEEuEF3AzDAS32-Pw", authDomain: "otpbywasi.firebaseapp.com", projectId: "otpbywasi", storageBucket: "otpbywasi.firebasestorage.app", messagingSenderId: "1169252296", appId: "1:1169252296:web:732c1f08f6b6ed7033eafd" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(), auth = firebase.auth();

        let currentUserName = "";

        // Auth Redirect
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection("users").doc(user.uid).get().then(doc => {
                    if (doc.exists) currentUserName = doc.data().username || "User";
                });
            } else { window.location.href = "auth"; }
        });

        // Top Right Notification Function
        function showNotification(msg, type) {
            const box = document.getElementById('notification-box');
            const icon = document.getElementById('notif-icon');
            const text = document.getElementById('notif-text');

            text.innerText = msg;
            box.className = type === 'success' ? 'bg-suc show' : 'bg-err show';
            icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';

            setTimeout(() => { box.classList.remove('show'); }, 4000);
        }

        async function startAutoVerify() {
            const trx = document.getElementById('trx-input').value.trim();
            const amt = document.getElementById('amt-input').value;
            const btn = document.getElementById('add-fund-btn');

            if(!trx || !amt) {
                showNotification("Please fill all fields", "error");
                return;
            }

            if(parseFloat(amt) < 50) {
                showNotification("Minimum payment is 50 Rs", "error");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Checking...";

            try {
                // Call the Auto-Deposit API Webhook
                const response = await fetch('/api/auto-deposit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: "verify_user_trx",
                        trx_id: trx,
                        amount: amt,
                        uid: auth.currentUser.uid,
                        username: currentUserName
                    })
                });

                const res = await response.json();

                if (res.status === "SUCCESS") {
                    showNotification("Payment Verified!", "success");
                    setTimeout(() => { window.location.href = "user"; }, 2000);
                } else if (res.status === "USED") {
                    showNotification("Transaction ID already used", "error");
                } else if (res.status === "NOT_FOUND") {
                    showNotification("Payment not Received", "error");
                } else {
                    showNotification(res.msg || "Payment not verified try again", "error");
                }
            } catch (e) {
                showNotification("Payment not Recived try after 5 minutes", "error");
            }
            btn.disabled = false;
            btn.innerText = "Add Fund";
        }
    </script>
</body>
</html>
