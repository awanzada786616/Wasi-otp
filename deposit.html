<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Balance | WASI OTP</title>
    
    <!-- CSS & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Public+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        html { display: none; } /* Zero Flash Security */
        body { font-family: 'Public Sans', sans-serif; background-color: #f4f6f9; transition: all 0.3s ease; }
        .dark body { background-color: #0f172a; }
        .font-brand { font-family: 'Montserrat', sans-serif; }
        .hero-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        
        #sidebar { transition: transform 0.3s ease; }
        .sidebar-open #sidebar { transform: translateX(0); }
        
        #toast { visibility: hidden; min-width: 280px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 16px; padding: 16px; position: fixed; z-index: 200; left: 50%; top: 30px; transform: translateX(-50%); font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {top: 0; opacity: 0;} to {top: 30px; opacity: 1;} }
        @keyframes fadeout { from {top: 30px; opacity: 1;} to {top: 0; opacity: 0;} }

        .gateway-card { transition: transform 0.2s ease; }
        .gateway-card:hover { transform: translateY(-5px); }
    </style>

    <script>
        // 1. ANTI-DEBUGGER
        setInterval(() => { debugger; }, 100);

        // 2. OBFUSCATED FIREBASE CONFIG
        const _0x4a21 = ["QUl6YVN5Q1Z0MFpGb1UyNkRhLWpqQ1FFRXVFRjNBekRBUzMyLVB3","b3RwYnl3YXNpLmZpcmViYXNlYXBwLmNvbQ==","aHR0cHM6Ly9vdHBieXdhc2ktZGVmYXVsdC1ydGRiLmZpcmViYXNlaW8uY29t","b3RwYnl3YXNp","b3RwYnl3YXNpLmZpcmViYXNlc3RvcmFnZS5hcHA=","MTE2OTI1MjI5Ng==","MToxMTY5MjUyMjk2OndlYjo3MzJjMWYwOGY2YjZlZDcwMzNlYWZk"];
        const firebaseConfig = {
            apiKey: atob(_0x4a21[0]), authDomain: atob(_0x4a21[1]), databaseURL: atob(_0x4a21[2]),
            projectId: atob(_0x4a21[3]), storageBucket: atob(_0x4a21[4]), messagingSenderId: atob(_0x4a21[5]), appId: atob(_0x4a21[6])
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 3. HEAD-LEVEL AUTH GUARD
        auth.onAuthStateChanged((user) => {
            if (!user) { window.location.replace("auth"); }
            else { document.documentElement.style.display = "block"; }
        });
    </script>
</head>
<body class="text-slate-900 dark:text-gray-100 min-h-screen">

    <div id="toast">Message</div>

    <!-- Approval Success Modal -->
    <div id="approval-modal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[120] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-sm p-10 shadow-2xl text-center">
            <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 text-green-500 rounded-full flex items-center justify-center text-4xl mx-auto mb-6">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="text-2xl font-black mb-2 font-brand uppercase italic text-green-600 tracking-tighter">Deposit Added!</h3>
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-8 font-semibold">Your funds have been successfully approved and added to your wallet.</p>
            <button onclick="closeApprovalModal()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-lg shadow-green-200 transition-all active:scale-95">Great, Thanks!</button>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/40 z-[60] hidden"></div>

    <!-- Sidebar Menu -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white dark:bg-slate-900 z-[70] -translate-x-full border-r dark:border-slate-800 p-6 shadow-2xl">
        <div class="flex items-center gap-3 mb-10 p-2">
            <div class="bg-primary p-2 rounded-lg text-white shadow-lg"><i class="fas fa-sms text-xl"></i></div>
            <span class="text-2xl font-black uppercase tracking-tighter font-brand text-primary">WASI OTP</span>
        </div>
        <nav class="space-y-2">
            <a href="user" class="flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-all font-semibold"><i class="fas fa-house"></i> Home</a>
            <a href="deposit" class="flex items-center gap-4 p-4 rounded-2xl bg-indigo-50 dark:bg-indigo-900/20 text-primary font-bold"><i class="fas fa-wallet"></i> Recharge Wallet</a>
            <a href="history" class="flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-slate-800 transition-all font-semibold"><i class="fas fa-history"></i> My History</a>
            <hr class="my-6 border-gray-100 dark:border-slate-800">
            <button onclick="logout()" class="flex items-center gap-4 p-4 rounded-2xl text-red-500 hover:bg-red-50 w-full font-bold transition-all"><i class="fas fa-power-off"></i> Logout</button>
        </nav>
    </aside>

    <!-- Navbar -->
    <nav class="bg-white dark:bg-slate-900 border-b dark:border-slate-800 sticky top-0 z-50 px-4 py-3 shadow-sm">
        <div class="container mx-auto flex justify-between items-center max-w-2xl">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="w-10 h-10 rounded-xl bg-gray-50 dark:bg-slate-800 text-indigo-600 flex items-center justify-center border dark:border-slate-700">
                    <i class="fas fa-bars-staggered"></i>
                </button>
                <span class="text-lg font-bold font-brand text-indigo-600 dark:text-indigo-400">DEPOSIT</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="bg-green-50 dark:bg-green-900/20 text-green-600 px-4 py-2 rounded-xl font-black text-sm border border-green-100 dark:border-green-900/30 shadow-sm">
                    <span id="top-balance">0.00</span> <span class="text-[10px] ml-0.5">PKR</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-6 max-w-2xl">
        
        <!-- Instruction Card -->
        <div class="hero-gradient rounded-[2.5rem] p-8 text-white shadow-xl mb-8 relative overflow-hidden">
            <div class="relative z-10">
                <h1 class="text-2xl font-black mb-1 italic uppercase tracking-tighter italic">Recharge Funds</h1>
                <p class="text-xs opacity-80 font-bold mb-6">Send payment to any gateway below.</p>
                <div class="bg-red-500/20 border border-white/20 p-4 rounded-2xl flex items-center gap-3">
                    <i class="fas fa-circle-info text-yellow-300 animate-pulse text-xl"></i>
                    <div>
                        <p class="text-[10px] font-black uppercase tracking-widest">Important Note</p>
                        <p class="text-[11px] font-bold leading-relaxed">Minimum deposit is Rs 100. Entering fake TRX ID will lead to account ban.</p>
                    </div>
                </div>
            </div>
            <div class="absolute -right-10 -bottom-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
        </div>

        <!-- Dynamic Gateways (Loaded from Admin) -->
        <div id="gateways-list" class="space-y-5 mb-10">
            <div class="text-center py-10 opacity-20"><i class="fas fa-circle-notch animate-spin text-3xl"></i></div>
        </div>

        <!-- Submission Form -->
        <div class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] shadow-sm border border-gray-100 dark:border-slate-800">
            <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6 italic"><i class="fas fa-file-pen text-primary mr-2"></i>Submission Form</h2>
            <div class="space-y-5">
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-2 ml-1">Deposit Amount</label>
                    <input type="number" id="deposit-amount" placeholder="Min 50 PKR" class="w-full bg-gray-50 dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-primary font-black text-lg">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-2 ml-1">Transaction ID (TRX ID)</label>
                    <input type="text" id="trx-id" placeholder="Paste TRX ID from SMS/App" class="w-full bg-gray-50 dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-primary font-bold">
                </div>
                <button onclick="submitDeposit()" id="submit-btn" class="w-full bg-indigo-600 text-white font-black py-5 rounded-[1.5rem] shadow-xl shadow-indigo-200 active:scale-95 transition-all text-xs uppercase tracking-widest">
                    Submit Payment Request
                </button>
            </div>
        </div>

        <p class="text-center text-gray-400 text-[10px] font-black uppercase mt-10 tracking-[0.2em] opacity-60">
            Payments are verified by our support team
        </p>

    </main>

    <!-- Floating WhatsApp -->
    <a href="https://wa.me/923342002756" target="_blank" class="fixed bottom-6 right-6 bg-green-500 text-white p-4 rounded-2xl shadow-2xl hover:scale-110 transition-all z-50">
        <i class="fab fa-whatsapp text-2xl"></i>
    </a>

    <script>
        let userName = "User";

        // --- AUTH & DATA SYNC ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection("users").doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('top-balance').innerText = (data.balance || 0).toFixed(2);
                        userName = data.username || data.name || "User";
                    }
                });
                watchApprovals(user.uid);
            }
        });

        // --- LOAD GATEWAYS WITH DESCRIPTION ---
        db.collection("gateways").onSnapshot(snap => {
            const cont = document.getElementById('gateways-list');
            cont.innerHTML = "";
            if(snap.empty) cont.innerHTML = "<p class='text-center text-xs opacity-30 font-bold'>No Active Gateways</p>";
            
            snap.forEach(doc => {
                const g = doc.data();
                cont.innerHTML += `
                    <div class="gateway-card bg-white dark:bg-slate-900 rounded-[2rem] border border-gray-100 dark:border-slate-800 shadow-sm overflow-hidden">
                        <div class="p-6 flex items-center gap-5">
                            <div class="w-14 h-14 bg-indigo-50 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center p-2 shadow-inner">
                                <img src="${g.logo}" class="w-full h-full object-contain">
                            </div>
                            <div class="flex-grow">
                                <p class="text-[9px] font-black text-indigo-500 uppercase tracking-widest mb-0.5">${g.name}</p>
                                <p class="text-xl font-black font-brand tracking-tighter">${g.number}</p>
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest opacity-70">${g.title}</p>
                            </div>
                            <button onclick="copyText('${g.number}')" class="w-11 h-11 bg-gray-50 dark:bg-slate-800 rounded-xl flex items-center justify-center text-slate-400 hover:text-primary transition-all">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        
                        <!-- Description Section -->
                        ${g.desc ? `
                        <div class="bg-indigo-50/30 dark:bg-slate-800/40 px-6 py-3 border-t border-gray-50 dark:border-slate-800/50">
                            <p class="text-[10px] text-indigo-600 dark:text-indigo-400 font-bold leading-relaxed italic">
                                <i class="fas fa-info-circle mr-1"></i> ${g.desc}
                            </p>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
        });

        // --- SUBMIT DEPOSIT ---
        async function submitDeposit() {
    const amt = parseFloat(document.getElementById('deposit-amount').value);
    const trx = document.getElementById('trx-id').value.trim();
    
    if(!amt || !trx) return showToast("âš ï¸ Fill all fields!");

    try {
        await db.collection("deposits").add({
            uid: auth.currentUser.uid,
            username: userName, // Ensure this variable has the actual username
            amount: amt,
            trx_id: trx,
            status: "pending", // Hamesha small letter mein rakhen
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast("âœ… Request Sent!");
    } catch (e) { 
        showToast("âŒ Error sending request");
    }
        }

        // --- REAL-TIME APPROVAL WATCHER ---
        function watchApprovals(uid) {
            db.collection("deposits")
              .where("uid", "==", uid)
              .where("status", "==", "approved")
              .onSnapshot(snap => {
                  snap.docChanges().forEach(change => {
                      if (change.type === "added" || change.type === "modified") {
                          const id = change.doc.id;
                          if (!localStorage.getItem(`approved_${id}`)) {
                              document.getElementById('approval-modal').classList.remove('hidden');
                              localStorage.setItem(`approved_${id}`, 'true');
                          }
                      }
                  });
              });
        }

        // --- UI HELPERS ---
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); }
        function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(() => x.className = "", 3000); }
        function copyText(val) { navigator.clipboard.writeText(val); showToast("ðŸ“‹ Copied: " + val); }
        function closeApprovalModal() { document.getElementById('approval-modal').classList.add('hidden'); }
        function logout() { auth.signOut().then(() => window.location.href = "auth"); }
        if (localStorage.theme === 'dark') document.documentElement.classList.add('dark');
    </script>
</body>
</html>
