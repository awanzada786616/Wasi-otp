<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WASI OTP - 5SIM</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { brand: { blue: '#0d6efd', dark: '#0b5ed7', light: '#e7f1ff' } },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'look-around': 'lookAround 2.5s infinite alternate' },
                    keyframes: {
                        lookAround: {
                            '0%, 10%': { transform: 'translate(0, 0)' },
                            '25%': { transform: 'translate(-10px, -5px)' },
                            '50%': { transform: 'translate(10px, 5px)' },
                            '75%': { transform: 'translate(-5px, 5px)' },
                            '90%, 100%': { transform: 'translate(0, 0)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Eye Animation */
        .eye-container {
            width: 120px; height: 120px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2), inset 0 0 20px rgba(0,0,0,0.1);
            position: relative; overflow: hidden; border: 4px solid #0d6efd;
        }
        .pupil {
            width: 40px; height: 40px; background: #0d6efd; border-radius: 50%;
            position: relative; box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
        }
        .pupil::after { content: ''; position: absolute; top: 8px; right: 8px; width: 12px; height: 12px; background: white; border-radius: 50%; }
        .eyelid {
            position: absolute; top: 0; left: 0; right: 0; height: 0%; background: #0d6efd; z-index: 10;
            animation: blink 4s infinite;
        }
        @keyframes blink { 0%, 90%, 100% { height: 0%; } 95% { height: 100%; } }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 5SIM CONFIGURATION ---
        // âš ï¸ Yahan apni 5SIM API Key dalein
        const API_KEY = "YOUR_5SIM_API_KEY_HERE"; 
        
        // Vercel Proxy Path
        const PROXY_URL = "/api/proxy"; 

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyA43N49sPsPs5NDfBUI4O2Zh_X_oLsl-dQ",
            authDomain: "wasi-otp.firebaseapp.com",
            projectId: "wasi-otp",
            storageBucket: "wasi-otp.firebasestorage.app",
            messagingSenderId: "992311938758",
            appId: "1:992311938758:web:20502825dd689293bf91c7"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const notify = (msg, type="success") => {
            Toastify({ 
                text: msg, duration: 3000, gravity: "top", position: "center", 
                style: { background: type==="success"?"#0d6efd":"#ef4444", borderRadius: "10px", fontWeight: "600" } 
            }).showToast();
        };

        // --- COMPONENTS ---

        const EyeLoader = () => (
            <div className="fixed inset-0 bg-white z-[99] flex flex-col items-center justify-center">
                <div className="eye-container mb-8">
                    <div className="eyelid"></div>
                    <div className="pupil animate-look-around"></div>
                </div>
                <h2 className="text-xl font-bold text-gray-800 animate-pulse">Wasi is Connecting...</h2>
                <p className="text-gray-400 text-sm mt-2">Connecting to 5SIM Servers</p>
            </div>
        );

        const AuthScreen = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState("");
            const [pass, setPass] = useState("");
            const [name, setName] = useState("");
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault(); setLoading(true);
                try {
                    if (isLogin) await auth.signInWithEmailAndPassword(email, pass);
                    else {
                        const cred = await auth.createUserWithEmailAndPassword(email, pass);
                        await db.collection('users').doc(cred.user.uid).set({ name, email, balance: 0, createdAt: Date.now() });
                    }
                } catch (err) { notify(err.message, "error"); }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-gray-50">
                    <div className="w-full max-w-sm bg-white p-8 rounded-3xl shadow-xl border border-gray-100">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-black text-brand-blue tracking-tight">WASI OTP</h1>
                            <p className="text-gray-400 text-sm">Secure Authentication</p>
                        </div>
                        <form onSubmit={handleAuth} className="space-y-4">
                            {!isLogin && <input className="w-full p-4 bg-gray-50 rounded-xl border outline-none" placeholder="Full Name" onChange={e=>setName(e.target.value)} required />}
                            <input className="w-full p-4 bg-gray-50 rounded-xl border outline-none" type="email" placeholder="Email Address" onChange={e=>setEmail(e.target.value)} required />
                            <input className="w-full p-4 bg-gray-50 rounded-xl border outline-none" type="password" placeholder="Password" onChange={e=>setPass(e.target.value)} required />
                            <button disabled={loading} className="w-full bg-brand-blue text-white py-4 rounded-xl font-bold shadow-lg hover:bg-brand-dark transition transform active:scale-95">
                                {loading ? <i className="fa-solid fa-spinner fa-spin"></i> : (isLogin ? "LOGIN" : "CREATE ACCOUNT")}
                            </button>
                        </form>
                        <p onClick={()=>setIsLogin(!isLogin)} className="text-center mt-6 text-gray-500 cursor-pointer text-sm font-medium hover:text-brand-blue">
                            {isLogin ? "New here? Create Account" : "Already have an account? Login"}
                        </p>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, balance, setView }) => {
            const [countries, setCountries] = useState([]);
            const [services, setServices] = useState([]);
            const [selCountry, setSelCountry] = useState(null);
            const [loadingSvc, setLoadingSvc] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const [showAll, setShowAll] = useState(false);

            // 1. Fetch Countries (API: /guest/countries)
            useEffect(() => {
                const fetchCountries = async () => {
                    try {
                        const res = await fetch(`${PROXY_URL}?token=${API_KEY}&endpoint=/guest/countries`);
                        const data = await res.json();
                        // 5sim returns { "afghanistan": { "iso": "af", "prefix": "+93" }, ... }
                        // Convert to array
                        const list = Object.keys(data).map(key => ({
                            id: key, // country name e.g. 'pakistan'
                            name: key.charAt(0).toUpperCase() + key.slice(1),
                            iso: data[key].iso
                        }));
                        
                        // Sort alphabetically for better UX
                        list.sort((a, b) => a.name.localeCompare(b.name));
                        
                        setCountries(list);
                        // Default to Pakistan if exists, else first
                        const defaultCountry = list.find(c => c.id === 'pakistan') || list[0];
                        setSelCountry(defaultCountry);

                    } catch(e) { console.error(e); notify("Failed to load regions", "error"); }
                };
                fetchCountries();
            }, []);

            // 2. Fetch Services (API: /guest/products/{country}/any)
            useEffect(() => {
                if(!selCountry) return;
                const fetchServices = async () => {
                    setLoadingSvc(true);
                    setServices([]);
                    try {
                        const res = await fetch(`${PROXY_URL}?token=${API_KEY}&endpoint=/guest/products/${selCountry.id}/any`);
                        const data = await res.json();
                        
                        // 5sim Data: { "whatsapp": { "Category": "activation", "Qty": 150, "Price": 10.5 }, ... }
                        // Note: Data format varies, sometimes it has operator keys inside.
                        // We will handle the most common format.
                        
                        const list = [];
                        Object.keys(data).forEach(key => {
                            const item = data[key];
                            // Sometimes item is object with providers { "any": {...}, "virt": {...} }
                            // We look for 'any' or just take the first provider available
                            const providerData = item.any || Object.values(item)[0];
                            
                            if(providerData) {
                                list.push({
                                    id: key, // product name e.g. 'whatsapp'
                                    name: key.toUpperCase(),
                                    price: Math.ceil(providerData.Price || 0), // Round up price
                                    count: providerData.Qty || 0
                                });
                            }
                        });

                        // Sort by stock
                        list.sort((a,b) => b.count - a.count);
                        setServices(list);

                    } catch(e) { console.error(e); }
                    setLoadingSvc(false);
                };
                fetchServices();
            }, [selCountry]);

            const filteredServices = services.filter(s => {
                const matchesSearch = s.name.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesStock = showAll ? true : s.count > 0;
                return matchesSearch && matchesStock;
            });

            const handleBuy = async (service) => {
                if(balance < service.price) return notify("Insufficient Balance", "error");
                if(service.count === 0) return notify("Out of Stock", "error");
                if(!confirm(`Buy ${service.name} for Rs ${service.price}?`)) return;

                notify("Requesting...", "info");
                try {
                    // API: /user/buy/activation/{country}/{operator}/{product}
                    // We use operator 'any'
                    const res = await fetch(`${PROXY_URL}?token=${API_KEY}&endpoint=/user/buy/activation/${selCountry.id}/any/${service.id}`);
                    const data = await res.json();

                    // Success response has 'id', 'phone', etc.
                    if(data.id && data.phone) {
                        const batch = db.batch();
                        batch.update(db.collection('users').doc(user.uid), { balance: firebase.firestore.FieldValue.increment(-service.price) });
                        batch.set(db.collection('orders').doc(data.id.toString()), { 
                            userId: user.uid, 
                            service: service.name, 
                            country: selCountry.name, 
                            number: data.phone, 
                            price: service.price, 
                            apiId: data.id, 
                            status: 'WAITING', 
                            code: null, 
                            timestamp: Date.now() 
                        });
                        await batch.commit();
                        notify("Number Received!"); setView('history');
                    } else {
                        // Error response usually has message
                        notify("Error: " + (JSON.stringify(data)), "error");
                    }
                } catch(e) { notify("Buy Error: " + e.message, "error"); }
            };

            const getFlag = (iso) => {
                // ISO code to Emoji Flag conversion logic can be complex.
                // Simple workaround: Use a map for popular ones or generic earth
                const flags = {"pk":"ğŸ‡µğŸ‡°","in":"ğŸ‡®ğŸ‡³","us":"ğŸ‡ºğŸ‡¸","ru":"ğŸ‡·ğŸ‡º","id":"ğŸ‡®ğŸ‡©","vn":"ğŸ‡»ğŸ‡³","cn":"ğŸ‡¨ğŸ‡³","gb":"ğŸ‡¬ğŸ‡§","ph":"ğŸ‡µğŸ‡­","bd":"ğŸ‡§ğŸ‡©","br":"ğŸ‡§ğŸ‡·","ng":"ğŸ‡³ğŸ‡¬","ke":"ğŸ‡°ğŸ‡ª"};
                return flags[iso] || "ğŸŒ";
            };

            return (
                <div className="pb-24">
                    <div className="bg-white px-6 py-5 sticky top-0 z-20 shadow-sm border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <h1 className="text-xl font-black text-brand-blue tracking-tighter">WASI OTP</h1>
                            <p className="text-xs text-gray-500 font-medium">Balance: <span className="text-gray-800 font-bold">Rs {balance}</span></p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>setView('deposit')} className="bg-green-50 text-green-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-green-100 transition"><i className="fa-solid fa-plus mr-1"></i> Add Fund</button>
                            <button onClick={()=>setView('history')} className="bg-gray-100 text-gray-600 w-9 h-9 rounded-xl flex items-center justify-center hover:bg-gray-200 transition"><i className="fa-solid fa-clock-rotate-left"></i></button>
                        </div>
                    </div>

                    <div className="mt-4 px-4">
                        <h3 className="text-[10px] font-bold text-gray-400 mb-2 uppercase tracking-widest">Select Region</h3>
                        <div className="flex gap-3 overflow-x-auto custom-scroll pb-2">
                            {countries.length===0 && <div className="text-xs text-gray-400 italic pl-1">Loading Regions...</div>}
                            {countries.map(c => (
                                <button key={c.id} onClick={()=>setSelCountry(c)} className={`px-4 py-3 rounded-xl flex-shrink-0 flex items-center gap-2 border transition duration-300 ${selCountry?.id===c.id ? 'bg-brand-blue text-white border-brand-blue shadow-lg shadow-blue-200' : 'bg-white text-gray-600 border-gray-200 hover:border-brand-blue'}`}>
                                    <span className="text-lg">{getFlag(c.iso)}</span>
                                    <span className="font-bold text-xs whitespace-nowrap">{c.name}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="mt-6 px-4">
                        <div className="flex justify-between items-end mb-3">
                             <h3 className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{selCountry ? selCountry.name : 'Select Country'} Services</h3>
                             <label className="text-xs text-gray-500 flex items-center gap-1 cursor-pointer font-medium bg-white px-2 py-1 rounded-lg border border-gray-200">
                                <input type="checkbox" className="accent-brand-blue" checked={showAll} onChange={e=>setShowAll(e.target.checked)} /> Show Empty
                             </label>
                        </div>

                        <div className="relative mb-4 group">
                            <i className="fa-solid fa-search absolute left-4 top-3.5 text-gray-400 group-focus-within:text-brand-blue transition"></i>
                            <input type="text" placeholder="Search Service..." value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-3 bg-white rounded-xl border border-gray-200 outline-none focus:border-brand-blue focus:ring-4 focus:ring-blue-50 transition shadow-sm" />
                        </div>

                        {loadingSvc ? <div className="text-center py-12"><i className="fa-solid fa-circle-notch fa-spin text-brand-blue text-3xl"></i></div> : 
                         filteredServices.length === 0 ? <div className="text-center py-16 text-gray-400 bg-white rounded-2xl border border-dashed border-gray-200"><p>{services.length > 0 ? "No Match Found" : "No Services Available"}</p></div> :
                         <div className="grid grid-cols-1 gap-3">
                            {filteredServices.map(p => (
                                <div key={p.id} className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex justify-between items-center hover:border-brand-blue hover:shadow-md transition group">
                                    <div className="flex items-center gap-4">
                                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-xl shadow-sm transition ${p.count > 0 ? 'bg-blue-50 text-brand-blue group-hover:bg-brand-blue group-hover:text-white' : 'bg-red-50 text-red-400'}`}>{p.name.charAt(0)}</div>
                                        <div><h4 className="font-bold text-gray-800 text-sm">{p.name}</h4><span className={`text-[10px] font-bold px-2 py-0.5 rounded ${p.count > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{p.count} Available</span></div>
                                    </div>
                                    <button onClick={()=>handleBuy(p)} disabled={p.count===0} className="bg-gray-900 text-white px-5 py-2.5 rounded-xl font-bold text-xs shadow-lg shadow-gray-200 hover:bg-brand-blue hover:shadow-blue-200 disabled:opacity-50 disabled:shadow-none transition active:scale-95">Rs {p.price}</button>
                                </div>
                            ))}
                         </div>
                        }
                    </div>
                </div>
            );
        };

        const HistoryPanel = ({ user, setView }) => {
            const [orders, setOrders] = useState([]);
            useEffect(() => { const unsub = db.collection('orders').where('userId','==',user.uid).onSnapshot(s => setOrders(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>b.timestamp-a.timestamp))); return () => unsub(); }, []);
            
            // Check Status Logic (API: /user/check/{id})
            useEffect(() => { 
                const interval = setInterval(() => { 
                    orders.filter(o => o.status === 'WAITING').forEach(async (order) => { 
                        try { 
                            const res = await fetch(`${PROXY_URL}?token=${API_KEY}&endpoint=/user/check/${order.apiId}`);
                            const data = await res.json();
                            
                            // 5sim Statuses: PENDING, RECEIVED, CANCELED, TIMEOUT, FINISHED, BANNED
                            if(data.status === 'RECEIVED' && data.sms && data.sms.length > 0) {
                                const code = data.sms[0].code; // Get first SMS code
                                await db.collection('orders').doc(order.id).update({ status: 'RECEIVED', code: code }); 
                                notify("OTP Received!", "success");
                            } else if (['CANCELED', 'TIMEOUT', 'BANNED'].includes(data.status)) {
                                await db.collection('orders').doc(order.id).update({ status: 'CANCELLED' }); 
                                await db.collection('users').doc(user.uid).update({ balance: firebase.firestore.FieldValue.increment(order.price) }); 
                            }
                        } catch(e) {} 
                    }); 
                }, 5000); 
                return () => clearInterval(interval); 
            }, [orders]);

            const cancelOrder = async (order) => {
                if(!confirm("Cancel this order?")) return;
                try {
                     const res = await fetch(`${PROXY_URL}?token=${API_KEY}&endpoint=/user/cancel/${order.apiId}`);
                     const data = await res.json();
                     // If success or error (handled by loop), UI will update
                     notify("Cancellation Requested", "info");
                } catch(e) { notify("Error", "error"); }
            };

            const copy = (t) => { navigator.clipboard.writeText(t); notify("Copied"); };
            return ( <div className="min-h-screen bg-gray-50"><div className="bg-white p-4 border-b flex gap-4 sticky top-0 z-10"><button onClick={()=>setView('home')}><i className="fa-solid fa-arrow-left text-gray-600"></i></button><span className="font-bold">History</span></div><div className="p-4 space-y-3">{orders.map(o => (<div key={o.id} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><div className="flex justify-between mb-2"><span className="font-bold text-sm">{o.service} <span className="text-xs text-gray-500 font-normal">({o.country})</span></span><span className={`text-[10px] font-bold px-2 py-1 rounded ${o.status==='WAITING'?'bg-yellow-100 text-yellow-700 animate-pulse':'bg-green-100 text-green-700'}`}>{o.status}</span></div><div className="bg-gray-50 p-3 rounded-xl flex justify-between font-mono font-bold text-gray-700 text-sm border border-gray-100">{o.number} <i className="fa-regular fa-copy cursor-pointer text-gray-400 hover:text-brand-blue" onClick={()=>copy(o.number)}></i></div><div className="mt-3 text-center text-sm">{o.status==='WAITING' ? <div className="flex justify-between items-center mt-2"><span className="text-gray-400 text-xs"><i className="fa-solid fa-spinner fa-spin mr-1"></i> Waiting...</span> <button onClick={()=>cancelOrder(o)} className="text-red-500 text-xs font-bold border border-red-200 px-2 py-1 rounded">CANCEL</button></div> : o.status==='RECEIVED' ? <span className="text-xl font-bold text-green-600 tracking-widest bg-green-50 px-4 py-1 rounded-lg border border-green-100 block">{o.code}</span> : <span className="text-red-400 text-xs">Cancelled</span>}</div></div>))}</div></div> );
        };

        const DepositPanel = ({ user, setView }) => {
            const [amt, setAmt] = useState("");
            const sub = async () => { if(amt<100) return notify("Min 100", "error"); await db.collection('deposits').add({ userId: user.uid, amount: Number(amt), status: 'pending', timestamp: Date.now() }); notify("Request Sent"); setView('home'); };
            return ( <div className="min-h-screen bg-gray-50"><div className="bg-white p-4 border-b flex gap-4"><button onClick={()=>setView('home')}><i className="fa-solid fa-arrow-left text-gray-600"></i></button> <span className="font-bold">Deposit</span></div><div className="p-6"><div className="bg-white p-6 rounded-3xl text-center shadow-sm mb-6 border border-gray-100"><div className="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 text-2xl"><i className="fa-solid fa-wallet"></i></div><h2 className="text-2xl font-black text-gray-800">03175768178</h2><p className="text-gray-500 font-medium text-sm">Easypaisa - Munir Akhtar</p></div><label className="text-xs font-bold text-gray-500 ml-1 mb-1 block">ENTER AMOUNT</label><input type="number" placeholder="e.g. 500" value={amt} onChange={e=>setAmt(e.target.value)} className="w-full p-4 rounded-xl border border-gray-200 outline-none focus:border-brand-blue transition mb-4" /><button onClick={sub} className="w-full bg-brand-blue text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-brand-dark transition">SUBMIT REQUEST</button></div></div> );
        };

        const App = () => { const [user, setUser] = useState(null); const [balance, setBalance] = useState(0); const [view, setView] = useState('home'); const [showEye, setShowEye] = useState(false); useEffect(() => { auth.onAuthStateChanged(u => { if(u) { setShowEye(true); setTimeout(() => setShowEye(false), 2500); db.collection('users').doc(u.uid).onSnapshot(d => setBalance(d.data()?.balance || 0)); } setUser(u); }); }, []); if(!user) return <AuthScreen />; if(showEye) return <EyeLoader />; return ( <div className="max-w-md mx-auto bg-gray-50 min-h-screen shadow-2xl relative border-x border-gray-100"> {view === 'home' && <Dashboard user={user} balance={balance} setView={setView} />} {view === 'history' && <HistoryPanel user={user} setView={setView} />} {view === 'deposit' && <DepositPanel user={user} setView={setView} />} <a href="https://wa.me/923342002756" target="_blank" className="fixed bottom-6 right-6 z-40 bg-[#25D366] text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition animate-bounce"><i className="fa-brands fa-whatsapp text-3xl"></i></a> </div> ); };
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
